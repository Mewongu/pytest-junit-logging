name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v2.1.3, etc.

permissions:
  contents: read
  id-token: write  # Required for PyPI trusted publishing

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build setuptools-scm

    - name: Get version from tag
      id: get-version
      run: |
        # Extract version from git tag
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Release version: ${VERSION}"

        # Validate version format (semantic versioning)
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+([.-][a-zA-Z0-9]+)*$ ]]; then
          echo "Error: Invalid version format. Use semantic versioning (e.g., 1.0.0, 2.1.3, 1.0.0-beta1)"
          exit 1
        fi

    - name: Verify setuptools-scm version matches tag
      run: |
        # Install the package to get setuptools-scm to generate version
        pip install -e .
        PACKAGE_VERSION=$(python -c "from pytest_junit_logging import __version__; print(__version__)")
        echo "Package version: ${PACKAGE_VERSION}"
        echo "Tag version: ${{ steps.get-version.outputs.version }}"

        if [ "${PACKAGE_VERSION}" != "${{ steps.get-version.outputs.version }}" ]; then
          echo "Error: Package version (${PACKAGE_VERSION}) doesn't match tag version (${{ steps.get-version.outputs.version }})"
          exit 1
        fi
        echo "✓ Version validation passed"

  test:
    name: Full Test Suite
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - python-version: "3.10"
            pytest-version: "8"
          - python-version: "3.11"
            pytest-version: "8"
          - python-version: "3.12"
            pytest-version: "8"
          - python-version: "3.13"
            pytest-version: "8"

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install "pytest>=8.0,<9.0" coverage[toml] pytest-cov
        pip install -e .

    - name: Run full test suite
      run: |
        pytest tests/ -v --cov=src/pytest_junit_logging --cov-report=term

    - name: Run integration tests
      run: |
        # Integration tests are part of the main test suite (tests/test_integration.py)
        # No separate validation needed - they're comprehensive end-to-end tests
        echo "✓ Integration tests included in main test suite"

  quality:
    name: Code Quality
    needs: validate
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install quality tools
      run: |
        python -m pip install --upgrade pip
        pip install ruff black mypy
        pip install -e .

    - name: Check formatting
      run: black --check src/ tests/

    - name: Lint code
      run: ruff check src/ tests/

    - name: Type check
      run: mypy src/

  build:
    name: Build Package
    needs: [validate, test, quality]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package
      run: |
        twine check dist/*

        # Verify package contents
        python -c "
        import tarfile
        import zipfile
        import os

        # Check sdist
        sdist_files = [f for f in os.listdir('dist') if f.endswith('.tar.gz')]
        if sdist_files:
            print(f'✓ Source distribution: {sdist_files[0]}')

        # Check wheel
        wheel_files = [f for f in os.listdir('dist') if f.endswith('.whl')]
        if wheel_files:
            print(f'✓ Wheel distribution: {wheel_files[0]}')

            # Verify wheel contents
            with zipfile.ZipFile(f'dist/{wheel_files[0]}', 'r') as wf:
                files = wf.namelist()
                required_files = [
                    'pytest_junit_logging/__init__.py',
                    'pytest_junit_logging/plugin.py',
                    'pytest_junit_logging/log_capture.py',
                    'pytest_junit_logging/xml_formatter.py'
                ]
                for req_file in required_files:
                    if not any(req_file in f for f in files):
                        raise RuntimeError(f'Required file {req_file} not found in wheel')
                print(f'✓ Wheel contains all required files')
        "

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-${{ needs.validate.outputs.version }}
        path: dist/

  publish:
    name: Publish to PyPI
    needs: [validate, test, quality, build]
    runs-on: ubuntu-latest
    environment: pypi

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-${{ needs.validate.outputs.version }}
        path: dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true
        verbose: true

    - name: Verify PyPI upload
      run: |
        sleep 60  # Wait for PyPI to process the upload
        pip install pytest-junit-logging==${{ needs.validate.outputs.version }}
        python -c "
        import pytest_junit_logging
        print(f'✓ Successfully installed pytest-junit-logging {pytest_junit_logging.__version__} from PyPI')
        "

  github-release:
    name: Create GitHub Release
    needs: [validate, publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate changelog
      id: changelog
      run: |
        # Get commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
          echo "Changes since ${LAST_TAG}:" > changelog.md
          git log ${LAST_TAG}..HEAD --pretty=format:"- %s" >> changelog.md
        else
          echo "Initial release" > changelog.md
        fi

        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat changelog.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ needs.validate.outputs.version }}
        body: |
          ## pytest-junit-logging ${{ needs.validate.outputs.version }}

          ${{ steps.changelog.outputs.changelog }}

          ## Installation
          ```bash
          pip install pytest-junit-logging==${{ needs.validate.outputs.version }}
          ```

          ## PyPI
          https://pypi.org/project/pytest-junit-logging/${{ needs.validate.outputs.version }}/
        draft: false
        prerelease: ${{ contains(github.ref, '-') }}
