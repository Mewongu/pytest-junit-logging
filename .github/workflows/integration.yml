name: Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  integration:
    name: End-to-End Integration
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install "pytest>=8.0,<9.0"
        pip install -e .

    - name: Run unit tests first
      run: |
        pytest tests/ -v --tb=short

    - name: Test plugin with example tests (DEBUG level)
      run: |
        cd tests_example
        pytest --junit-xml=../integration-debug.xml --junit-log-level=DEBUG -v
        cd ..

    - name: Test plugin with example tests (WARNING level)
      run: |
        cd tests_example
        pytest --junit-xml=../integration-warning.xml --junit-log-level=WARNING -v
        cd ..

    - name: Test plugin with example tests (ERROR level)
      run: |
        cd tests_example
        pytest --junit-xml=../integration-error.xml --junit-log-level=ERROR -v
        cd ..

    - name: Validate XML output structure
      run: |
        python -c "
        import xml.etree.ElementTree as ET
        import sys
        
        def validate_xml(filename, expected_min_logs, log_level):
            print(f'Validating {filename} for {log_level} level...')
            
            try:
                tree = ET.parse(filename)
                root = tree.getroot()
                
                # Find all log sections
                logs_sections = root.findall('.//logs')
                if len(logs_sections) == 0:
                    print(f'  âœ— No logs sections found in {filename}')
                    return False
                
                print(f'  âœ“ Found {len(logs_sections)} logs sections')
                
                # Count total log entries
                all_logs = root.findall('.//log')
                if len(all_logs) < expected_min_logs:
                    print(f'  âœ— Expected at least {expected_min_logs} log entries, found {len(all_logs)}')
                    return False
                
                print(f'  âœ“ Found {len(all_logs)} log entries (>= {expected_min_logs} expected)')
                
                # Check that logs have required attributes
                for log in all_logs[:3]:  # Check first 3 logs
                    required_attrs = ['step', 'ts', 'level', 'src']
                    for attr in required_attrs:
                        if log.get(attr) is None:
                            print(f'  âœ— Log missing required attribute: {attr}')
                            return False
                    
                    # Validate step attribute values
                    step = log.get('step')
                    if step not in ['setup', 'test', 'teardown']:
                        print(f'  âœ— Invalid step attribute value: {step}')
                        return False
                
                print(f'  âœ“ Log attributes validation passed')
                
                # Check log levels are appropriate
                log_levels = [log.get('level') for log in all_logs]
                print(f'  âœ“ Log levels found: {set(log_levels)}')
                
                return True
                
            except Exception as e:
                print(f'  âœ— Error validating {filename}: {e}')
                return False
        
        # Validate each XML file
        success = True
        success &= validate_xml('integration-debug.xml', 5, 'DEBUG')
        success &= validate_xml('integration-warning.xml', 1, 'WARNING') 
        success &= validate_xml('integration-error.xml', 1, 'ERROR')
        
        if success:
            print('\nðŸŽ‰ All integration tests passed!')
        else:
            print('\nâŒ Integration validation failed')
            sys.exit(1)
        "

    - name: Upload integration test XML files
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-xml-reports
        path: integration-*.xml

    - name: Test plugin compatibility with pytest-xdist (parallel execution)
      run: |
        pip install pytest-xdist
        cd tests_example
        pytest --junit-xml=../parallel-test.xml -n auto -v
        cd ..

    - name: Validate parallel execution XML
      run: |
        python -c "
        import xml.etree.ElementTree as ET
        
        tree = ET.parse('parallel-test.xml')
        logs = tree.findall('.//logs')
        
        if len(logs) == 0:
            print('âœ— No logs found in parallel execution')
            exit(1)
        
        print(f'âœ“ Parallel execution produced {len(logs)} logs sections')
        print('âœ“ Plugin works correctly with pytest-xdist')
        "

  compatibility:
    name: Compatibility Testing
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install and test plugin installation
      run: |
        python -m pip install --upgrade pip
        pip install "pytest>=8.0,<9.0"
        pip install -e .
        
        # Test that plugin registers correctly
        python -c "
        import pkg_resources
        eps = list(pkg_resources.iter_entry_points('pytest11', 'pytest_junit_logging'))
        if not eps:
            raise RuntimeError('Plugin entry point not found')
        print(f'âœ“ Plugin entry point found: {eps[0]}')
        "

    - name: Quick integration test
      run: |
        cd tests_example
        pytest --junit-xml=quick-test.xml -v
        cd ..
        
        # Verify XML contains logs
        python -c "
        import xml.etree.ElementTree as ET
        tree = ET.parse('tests_example/quick-test.xml')
        logs = tree.findall('.//logs')
        assert len(logs) > 0, 'No logs found in quick integration test'
        print('âœ“ Quick integration test passed')
        "